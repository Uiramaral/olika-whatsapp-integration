name: üöÄ Deploy Client to Railway

on:
  workflow_dispatch:
    inputs:
      client_id:
        description: 'ID do cliente'
        required: true
        type: string
      client_name:
        description: 'Nome do cliente'
        required: true
        type: string
      client_slug:
        description: 'Slug √∫nico (ex: pizzaria-bella-vista-1234)'
        required: true
        type: string
      environment:
        description: 'Ambiente de deploy'
        required: false
        type: choice
        options:
          - production
          - staging
        default: production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Reposit√≥rio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: üì¶ Instalar Depend√™ncias
        run: npm ci

      - name: üöÄ Deploy no Railway
        uses: railwayapp/action@v2
        with:
          railwayToken: ${{ secrets.RAILWAY_TOKEN }}
          serviceName: olika-gateway
          environment: ${{ github.event.inputs.environment }}

      - name: üßæ Callback para Laravel
        env:
          LARAVEL_WEBHOOK_URL: ${{ secrets.LARAVEL_WEBHOOK_URL }}
        run: |
          echo "‚úÖ Notificando Laravel sobre o deploy..."
          
          if [ -n "$LARAVEL_WEBHOOK_URL" ]; then
            curl -X POST "$LARAVEL_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{
                \"client_id\": \"${{ github.event.inputs.client_id }}\",
                \"client_slug\": \"${{ github.event.inputs.client_slug }}\",
                \"status\": \"completed\",
                \"branch\": \"${{ github.ref_name }}\",
                \"run_id\": \"${{ github.run_id }}\"
              }" || echo "‚ö†Ô∏è Falha ao notificar Laravel, mas deploy foi conclu√≠do"
          else
            echo "‚ö†Ô∏è LARAVEL_WEBHOOK_URL n√£o configurado, pulando callback"
          fi


